# AMM 去中心化交易所

基于 Uniswap V2 的自动做市商（AMM）平台，采用可升级合约架构，支持去中心化代币交换和流动性挖矿。

## 项目特性

- **可升级架构**: 基于 OpenZeppelin 的可升级合约框架
- **安全性**: 集成重入保护、暂停机制和所有权控制
- **兼容性**: 完全兼容 Uniswap V2 协议
- **类型安全**: 使用 TypeScript 和 Hardhat 开发框架

## 合约文档

- [工厂合约 (AMMFactory)](./AMMFactory.md)
- [配对合约 (AMMTokenPair)](./AMMTokenPair.md)
- [路由合约 (AMMRouter01)](./AMMRouter.md)

## 合约结构

```mermaid
graph TD
    A(AMMRouter01) --> B(AMMFactory)
    B --> C(AMMTokenPair)
    A --> C
    D(用户) --> A
    E(WETH) --> A
    F(ERC20代币) --> C
```

### 核心合约

1. **AMMFactory**: 工厂合约，负责创建和管理交易对
2. **AMMTokenPair**: 配对合约，实现具体的交易和流动性功能
3. **AMMRouter01**: 路由合约，为用户提供便捷的交互接口

## 技术架构

### 开发框架

- **Hardhat**: 以太坊开发环境
- **TypeScript**: 类型安全的开发语言
- **OpenZeppelin**: 安全的智能合约库
- **Ethers.js**: 以太坊交互库

### 合约特性

- **可升级性**: 使用代理模式支持合约升级
- **安全性**: 重入保护、暂停机制、权限控制
- **Gas 优化**: 优化的算法和存储布局
- **事件日志**: 完整的事件记录用于前端集成

## 主要功能

### 1. 流动性管理

- **添加流动性**: 向交易对提供代币获得 LP 代币
- **移除流动性**: 销毁 LP 代币取回代币和收益
- **流动性挖矿**: LP 代币持有者获得交易手续费分成

### 2. 代币交换

- **精确输入交换**: 指定输入数量进行交换
- **精确输出交换**: 指定输出数量进行交换
- **多路径交换**: 通过多个交易对进行复杂路径交换
- **ETH 支持**: 原生支持 ETH 与 ERC20 代币交换

### 3. 价格发现

- **恒定乘积公式**: x \* y = k 自动定价机制
- **价格预言机**: 内置时间加权平均价格（TWAP）
- **滑点保护**: 最小输出数量保护

## 运行逻辑

### 部署流程

1. 部署 AMMFactory 工厂合约
2. 设置手续费管理员地址
3. 部署 AMMRouter01 路由合约
4. 初始化路由合约，关联工厂和 WETH 地址

### 交易流程

1. **创建交易对**: 通过工厂合约为两个代币创建交易对
2. **添加流动性**: 向交易对存入代币，获得 LP 代币
3. **代币交换**: 通过路由合约进行代币交换
4. **移除流动性**: 销毁 LP 代币，取回代币和收益

### 技术细节

- **CREATE2 部署**: 交易对地址可预先计算
- **代币排序**: 按地址大小排序确保唯一性
- **手续费机制**: 每笔交易收取 0.3% 手续费
- **最小流动性**: 首次添加流动性永久锁定 1000 wei

## 安全特性

### 合约安全

- **重入保护**: 防止重入攻击
- **暂停机制**: 紧急情况下可暂停合约
- **权限控制**: 关键操作需要管理员权限
- **溢出保护**: 使用 SafeMath 防止整数溢出

### 经济安全

- **滑点保护**: 最小输出数量保护用户
- **截止时间**: 防止交易在不利条件下执行
- **K 值检查**: 确保恒定乘积公式不被违反

## 开发指南

### 环境要求

- Node.js >= 16
- npm 或 yarn
- Hardhat

### 安装依赖

```bash
npm install
```

### 编译合约

```bash
npx hardhat compile
```

### 运行测试

```bash
npx hardhat test
```

### 部署合约

```bash
npx hardhat run scripts/deploy.ts --network <network>
```

## 测试覆盖

项目包含完整的测试套件：

- **AMMFactory.spec.ts**: 工厂合约测试
- **AMMTokenPair.spec.ts**: 配对合约测试
- **共享工具**: 测试辅助函数和固定装置

## 许可证

GPL-3.0-or-later

## 注意事项

1. **合约升级**: 升级时需要确保存储布局兼容性
2. **权限管理**: 妥善保管管理员私钥
3. **测试环境**: 在主网部署前充分测试
4. **Gas 费用**: 注意 Gas 费用优化
5. **安全审计**: 建议进行专业安全审计

## 贡献指南

欢迎提交 Issue 和 Pull Request 来改进项目。请确保：

- 遵循代码规范
- 添加相应测试
- 更新相关文档
